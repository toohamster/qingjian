<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Excel Merge | 仓鼠</title>
<meta name="author" content="toohamster">
<meta name="viewport" content="initial-scale=1.0,minimum-scale=1,maximum-scale=1,user-scalable=no">
<style>
#container{
	margin: 0 auto;
	width: 80%;
}
#container h1 {
	text-align: center;
}
#oop {
	border: 1px solid solid;
	min-height: 300px;
	background: gray;
	padding-left: 10px;
}
</style>
</head>
<body>
<div id="container">
	<h1>Excel Merge</h1><br />
	
	<p>
		<label for="xlf1">Excel 1: </label>
		<input type="file" name="xlfile" id="xlf1" />&nbsp;&nbsp;&nbsp;		
	</p>

	<p>
		<label for="xlf2">Excel 2: </label>
		<input type="file" name="xlfile2" id="xlf2" />&nbsp;&nbsp;&nbsp;		
	</p>

	<p>
		关联字段: &nbsp;
		<select id="sltWb1"></select>
		&nbsp;&nbsp;VS&nbsp;&nbsp;
		<select id="sltWb2"></select>
	</p>

	<p>
		<input type="button" id="fileParse" value="解析"/>
		<input type="button" id="fileExport" value="下载"/>
	</p>
	<div style="display:none;">
		useworker<input type="checkbox" name="useworker" checked><br />
		xferable<input type="checkbox" name="xferable" checked><br />
		userabs<input type="checkbox" name="userabs" checked><br />
	</div>
	<p></p>
	<div id="oop">
		<pre id="out"></pre>
	</div>
</div>
</body>
<!-- uncomment the next line here and in xlsxworker.js for encoding support -->
<script src="js/shim.js"></script>
<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<!-- uncomment the next line here and in xlsxworker.js for ODS support -->
<script src="js/ods.js"></script>
<script src="js/sxexport.js"></script>
<script src="js/j.js"></script>
<script>
if (!String.prototype.trim) {
  String.prototype.trim = function () {
    return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
  };
}

var X = XLSX;
var XW = {
	/* worker message */
	msg: 'xlsx',
	/* worker scripts */
	rABS: './js/xlsxworker2.js',
	norABS: './js/xlsxworker1.js',
	noxfer: './js/xlsxworker.js'
};

var rABS = typeof FileReader !== "undefined" && typeof FileReader.prototype !== "undefined" && typeof FileReader.prototype.readAsBinaryString !== "undefined";
if(!rABS) {
	document.getElementsByName("userabs")[0].disabled = true;
	document.getElementsByName("userabs")[0].checked = false;
}

var use_worker = typeof Worker !== 'undefined';
if(!use_worker) {
	document.getElementsByName("useworker")[0].disabled = true;
	document.getElementsByName("useworker")[0].checked = false;
}

var transferable = use_worker;
if(!transferable) {
	document.getElementsByName("xferable")[0].disabled = true;
	document.getElementsByName("xferable")[0].checked = false;
}

var wtf_mode = false;

function fixdata(data) {
	var o = "", l = 0, w = 10240;
	for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint8Array(data.slice(l*w,l*w+w)));
	o+=String.fromCharCode.apply(null, new Uint8Array(data.slice(l*w)));
	return o;
}

function ab2str(data) {
	var o = "", l = 0, w = 10240;
	for(; l<data.byteLength/w; ++l) o+=String.fromCharCode.apply(null,new Uint16Array(data.slice(l*w,l*w+w)));
	o+=String.fromCharCode.apply(null, new Uint16Array(data.slice(l*w)));
	return o;
}

function s2ab(s) {
	var b = new ArrayBuffer(s.length*2), v = new Uint16Array(b);
	for (var i=0; i != s.length; ++i) v[i] = s.charCodeAt(i);
	return [v, b];
}

function xw_noxfer(data, cb) {
	var worker = new Worker(XW.noxfer);
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready': break;
			case 'e': console.error(e.data.d); break;
			case XW.msg: cb(JSON.parse(e.data.d)); break;
		}
	};
	var arr = rABS ? data : btoa(fixdata(data));
	worker.postMessage({d:arr,b:rABS});
}

function xw_xfer(data, cb) {
	var worker = new Worker(rABS ? XW.rABS : XW.norABS);
	worker.onmessage = function(e) {
		switch(e.data.t) {
			case 'ready': break;
			case 'e': console.error(e.data.d); break;
			default: xx=ab2str(e.data).replace(/\n/g,"\\n").replace(/\r/g,"\\r"); console.log("done"); cb(JSON.parse(xx)); break;
		}
	};
	if(rABS) {
		var val = s2ab(data);
		worker.postMessage(val[1], [val[1]]);
	} else {
		worker.postMessage(data, [data]);
	}
}

function xw(data, cb) {
	transferable = document.getElementsByName("xferable")[0].checked;
	if(transferable) xw_xfer(data, cb);
	else xw_noxfer(data, cb);
}

function get_radio_value( radioName ) {
	var radios = document.getElementsByName( radioName );
	for( var i = 0; i < radios.length; i++ ) {
		if( radios[i].checked || radios.length === 1 ) {
			return radios[i].value;
		}
	}
}

function to_json(workbook) {
	var result = {};
	workbook.SheetNames.forEach(function(sheetName) {
		var roa = X.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
		if(roa.length > 0){
			result[sheetName] = roa;
		}
	});
	return result;
}
var filePool = [];
function to_csv(workbook) {
	filePool = [];
	var result = [];
	var ind = 0;
	workbook.SheetNames.forEach(function(sheetName) {
		var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
		if(csv.length > 0){
			result.push("工作簿: " + sheetName);
			result.push("");
			result.push(csv);
			filePool.push({name: sheetName + (ind++) + '.csv', content: csv});
		}
	});
	return result.join("\n");
}

function to_formulae(workbook) {
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var formulae = X.utils.get_formulae(workbook.Sheets[sheetName]);
		if(formulae.length > 0){
			result.push("工作簿: " + sheetName);
			result.push("");
			result.push(formulae.join("\n"));
		}
	});
	return result.join("\n");
}

function to_objs(workbook) {
	var result = [];
	workbook.SheetNames.forEach(function(sheetName) {
		var json = X.utils.sheet_to_json(workbook.Sheets[sheetName]);
		result.push(json)

		console.log(sheetName, json)
	});
	return result;
}

var Dwb1 = {
	f: [],
	r: []
};
var Dwb2 = {
	f: [],
	r: []
};

function process_wb1(wb) {
	var j = to_objs(wb)
	if (j.length > 0) {
		Dwb1.r = j[0];
		if (Dwb1.r.length > 0) {
			Dwb1.f = Object.keys(Dwb1.r[0]);
			console.warn(Dwb1.f)
		}
	}
	var f = rSelect(Dwb1.f)
	$('#sltWb1').empty().html(f);
	$('#fileExport').prop('disabled', true)
}

function process_wb2(wb) {
	var j = to_objs(wb)
	if (j.length > 0) {
		Dwb2.r = j[0];
		if (Dwb2.r.length > 0) {
			Dwb2.f = Object.keys(Dwb2.r[0]);
			console.warn(Dwb2.f)
		}
	}
	var f = rSelect(Dwb2.f)
	$('#sltWb2').empty().html(f);
	$('#fileExport').prop('disabled', true)
}

$('#sltWb2,#sltWb1').change(function(){
	$('#fileExport').prop('disabled', true)
})

$('#fileExport').prop('disabled', true)

function rSelect(f){
	
	var oop = '<option value="">请选择一个字段</option>';
	var oops = null;
	for (var i=0;i<f.length;i++) {
		oops = [
			'<option value="', f[i] ,'">',f[i],'</option>'
		];
		oop += oops.join('');
	}
	return oop
}

var xlf1 = document.getElementById('xlf1');
function handleFile1(e) {
	rABS = document.getElementsByName("userabs")[0].checked;
	use_worker = document.getElementsByName("useworker")[0].checked;
	var files = e.target.files;
	var f = files[0];
	{
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(use_worker) {
				xw(data, process_wb1);
			} else {
				var wb;
				if(rABS) {
					wb = X.read(data, {type: 'binary'});
				} else {
				var arr = fixdata(data);
					wb = X.read(btoa(arr), {type: 'base64'});
				}
				process_wb1(wb);
			}
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	}
}

if(xlf1.addEventListener) xlf1.addEventListener('change', handleFile1, false);

var xlf2 = document.getElementById('xlf2');
function handleFile2(e) {
	rABS = document.getElementsByName("userabs")[0].checked;
	use_worker = document.getElementsByName("useworker")[0].checked;
	var files = e.target.files;
	var f = files[0];
	{
		var reader = new FileReader();
		var name = f.name;
		reader.onload = function(e) {
			if(typeof console !== 'undefined') console.log("onload", new Date(), rABS, use_worker);
			var data = e.target.result;
			if(use_worker) {
				xw(data, process_wb2);
			} else {
				var wb;
				if(rABS) {
					wb = X.read(data, {type: 'binary'});
				} else {
				var arr = fixdata(data);
					wb = X.read(btoa(arr), {type: 'base64'});
				}
				process_wb2(wb);
			}
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	}
}

if(xlf2.addEventListener) xlf2.addEventListener('change', handleFile2, false);

function findWb2Vrow(v1,fd)
{
	for (var i=0;i<Dwb2.r.length;i++) {
		var pr = $.trim(Dwb2.r[i][fd])
		if (pr == v1) {
			return Dwb2.r[i]
		}
	}
	return null
}

var DwbA = {
	f: [],
	r: []
};

function dParse()
{
	var sltWb1V = $("option:selected", '#sltWb1').val();
	var sltWb2V = $("option:selected", '#sltWb2').val();

	if (sltWb1V == '') {
		alert('未指定关联字段1')
		$('#sltWb1').focus()
		return false
	}
	if (sltWb2V == '') {
		alert('未指定关联字段2')
		$('#sltWb2').focus()
		return false
	}

	// 检测关联字段是否唯一
	var fc = null // pr 次数
	for (var i=0;i<Dwb1.r.length;i++) {
		var pr = $.trim(Dwb1.r[i][sltWb1V])
		if (pr == '') {
			alert("Excel1中的关联字段存在空值, 所在数据行: " + (i+1))
			return false
		}

		if (fc == pr) {
			alert("Excel1中的关联字段存在相同的值, 所在数据行: " + (i+1))
			return false
		}

		fc = pr
	}
	fc = null // pr 次数
	for (var i=0;i<Dwb2.r.length;i++) {
		var pr = $.trim(Dwb2.r[i][sltWb2V])
		if (pr == '') {
			alert("Excel2中的关联字段存在空值, 所在数据行: " + (i+1))
			return false
		}

		if (fc == pr) {
			alert("Excel2中的关联字段存在相同的值, 所在数据行: " + (i+1))
			return false
		}

		fc = pr
	}

	var dr1=null
	for (var i=0;i<Dwb1.r.length;i++) {
		dr1 = Dwb1.r[i]
		var pr1 = dr1[sltWb1V]
		var pr2 = findWb2Vrow(pr1,sltWb2V)
		console.log(pr2,sltWb2V)
		if (pr2 == null) {
			var fd = null
			for (var j=0;j<Dwb2.f.length;j++) {
				fd = Dwb2.f[j]
				if (!dr1[fd]) {
					dr1[fd] = ''
				}
			}
		}
		else {
			var fd = null
			var fv = null
			for (var j=0;j<Dwb2.f.length;j++) {
				fd = Dwb2.f[j]
				fv = $.trim(pr2[fd])

				if (fv == '') {
					dr1[fd] = !dr1[fd] ? fv : dr1[fd]	
				}
				else {
					dr1[fd] = fv
				}
			}
		}

		DwbA.r.push(dr1)
	}

	$('#out').text(JSON.stringify(DwbA.r, undefined, 4))

	if (DwbA.r.length>0) {
		DwbA.f = Object.keys(DwbA.r[0])
	}	
}

// 导出按钮
var btnSave = document.getElementById('fileExport');
var fileParse = document.getElementById('fileParse');
fileParse.addEventListener('click', function (e) {
	dParse();
	$('#fileExport').prop('disabled', false)
}); 

btnSave.addEventListener('click', function (e) {
	
	var ws = XLSX.utils.json_to_sheet(DwbA.r)
	var wb = XLSX.utils.book_new()
	XLSX.utils.book_append_sheet(wb, ws, "合并")
	XLSX.writeFile(wb, 'excel-merge.xlsx')
});

</script>

</html>
